# ╔════════════════════════════════════════════════════════════════════════════╗
# ║                    OpenClash 完整配置文件 - 最终版                          ║
# ║                         为小白用户详细注解版                                ║
# ║                          修改日期：2026年1月                                ║
# ╚════════════════════════════════════════════════════════════════════════════╝

# ════════════════════════════════════════════════════════════════════════════
# 📡 第一部分：机场节点订阅
# ════════════════════════════════════════════════════════════════════════════
# 说明：这里配置你购买的机场订阅链接，OpenClash 会定期从这里获取节点信息
proxy-providers:
  机场订阅:
    # ⚠️ 重要：把这个链接改成你自己的机场订阅链接
    url: "https://your-airport-subscribe-link.com"
    type: http              # 订阅方式：http（网络获取）
    interval: 86400         # 更新间隔：86400秒 = 24小时
    health-check:           # 节点健康检查设置
      enable: true          # 启用健康检查
      url: https://www.gstatic.com/generate_204  # 用谷歌这个地址测试网络延迟
      interval: 300         # 每300秒（5分钟）检查一次节点
    proxy: 直连             # 获取订阅时用直连（不走代理）

# ════════════════════════════════════════════════════════════════════════════
# 🔧 第二部分：本地节点定义
# ════════════════════════════════════════════════════════════════════════════
# 说明：这里定义本地节点，不需要改
proxies:
  - {name: 直连, type: direct}    # 直连：流量不走代理，直接连接
  - {name: 拒绝, type: reject}    # 拒绝：完全屏蔽这个流量

# ════════════════════════════════════════════════════════════════════════════
# ⚙️ 第三部分：全局配置
# ════════════════════════════════════════════════════════════════════════════
# 说明：OpenClash 的基础设置，一般不需要改

port: 7890                  # Clash 代理端口（HTTP、SOCKS5 监听这个端口）
socks-port: 7891           # SOCKS5 专用端口
redir-port: 7892           # 重定向端口（Linux 系统用）
mixed-port: 7893           # 混合端口（HTTP + SOCKS5）
tproxy-port: 7895          # TUN 模式端口

allow-lan: true             # 允许内网其他设备连接（必须 true，ADH 需要连这里）
bind-address: "*"           # 绑定所有 IP（允许其他设备访问）
mode: rule                  # 模式：rule = 按规则匹配，direct = 直连，global = 全部代理
log-level: warning          # 日志等级：silent < error < warning < info < debug

ipv6: false                 # 关闭 IPv6（国内基本用不上）

unified-delay: true         # 统一延迟计算（更准确的延迟显示）
tcp-concurrent: true        # TCP 并发连接（提速）
global-client-fingerprint: chrome  # 伪装成 Chrome 浏览器（反爬虫）
keep-alive-idle: 600        # 空闲连接保活时间（秒）
keep-alive-interval: 15     # 保活间隔（秒）

profile:
  store-selected: true      # 记住你上次选择的策略
  store-fake-ip: true       # 记住 fake-ip 映射（DNS 缓存）

# 控制面板设置（可选，如果用不到可以注释掉）
external-controller: 0.0.0.0:9090  # 控制面板监听 9090 端口
external-ui: ui                    # 使用内置 UI
secret: ""                         # 控制面板密码（留空 = 无密码）

# ════════════════════════════════════════════════════════════════════════════
# 👁️ 第四部分：嗅探配置
# ════════════════════════════════════════════════════════════════════════════
# 说明：嗅探可以识别流量属于哪个应用，提高规则匹配准确度

sniffer:
  enable: true              # 启用嗅探
  sniff:
    HTTP:
      ports: [80, 8080-8880]           # HTTP 端口范围
      override-destination: true       # 覆盖目标地址（更准确地识别）
    TLS:
      ports: [443, 8443]               # HTTPS 端口
    QUIC:
      ports: [443, 8443]               # QUIC 协议端口（HTTP/3）
  skip-domain:              # 这些域名不进行嗅探（加快速度）
    - Mijia Cloud           # 小米云
    - +.push.apple.com      # 苹果推送
    - +.icloud.com          # iCloud 服务

# ════════════════════════════════════════════════════════════════════════════
# 🌐 第五部分：TUN 模式配置（入站流量）
# ════════════════════════════════════════════════════════════════════════════
# 说明：TUN 模式可以拦截系统的所有网络流量（包括 UDP），比普通模式强大
# 在 iKuai 虚拟机上，auto-route 等选项一般都是 false

tun:
  enable: true              # 启用 TUN 模式
  stack: mixed              # 协议栈：gvisor（性能好）/ mixed（兼容好）
  dns-hijack: ["any:53", "tcp://any:53"]  # 劫持所有 DNS 查询到 OpenClash
  auto-route: false         # 关闭自动路由（虚拟机上保持 false）
  auto-redirect: false      # 关闭自动重定向
  auto-detect-interface: false  # 关闭自动检测接口

# ════════════════════════════════════════════════════════════════════════════
# 🔍 第六部分：DNS 配置（关键！）
# ════════════════════════════════════════════════════════════════════════════
# 说明：DNS 负责把域名转换成 IP 地址
# 流程：ADH 上游 → 192.168.10.2:7874 (OpenClash DNS) → nameserver 解析

dns:
  enable: true              # 启用 DNS 功能
  cache-algorithm: arc      # 缓存算法：arc（最优）
  listen: 0.0.0.0:7874      # 监听地址和端口（ADH 上游要指向这里！）
  ipv6: false               # 关闭 IPv6 DNS
  respect-rules: true       # 遵守规则（某些域名走代理 DNS，某些走直连 DNS）
  
  # Fake-IP 模式：给没有真实 IP 的域名分配一个虚拟 IP
  enhanced-mode: fake-ip    # 增强模式：fake-ip（加速）/ redir-host（兼容）
  fake-ip-range: 198.18.0.1/16  # 虚拟 IP 段（用不存在的 IP，避免冲突）
  fake-ip-filter-mode: blacklist  # 黑名单模式：这些域名不用 fake-ip
  fake-ip-filter:           # 不进行 fake-ip 的域名
    - "rule-set:fakeipfilter"  # 从规则集获取
  
  # 主 DNS 服务器（用于国内域名，快速）
  default-nameserver:
    - https://223.5.5.5/dns-query  # 阿里 DNS
  
  # 代理 DNS 服务器（用于 nameserver 的解析本身，防止污染）
  proxy-server-nameserver:
    - https://dns.alidns.com/dns-query   # 阿里
    - https://doh.pub/dns-query          # 腾讯
  
  # 主 DNS 列表（最常用，大多数域名用这个）
  nameserver:
    - https://dns.alidins.com/dns-query  # 阿里 DNS（快）
    - https://doh.pub/dns-query          # 腾讯 DNS（快）
  
  # 备用 DNS（当主 DNS 失败时使用）
  fallback:
    - https://dns.cloudflare.com/dns-query  # Cloudflare DNS（国际）
    - https://dns.google/dns-query          # Google DNS（国际）
  
  # 备用 DNS 的使用规则
  fallback-filter:
    geoip: true             # 使用 geoip 判断
    geosite:
      - gfw                 # GFW 列表里的域名才用 fallback

# ════════════════════════════════════════════════════════════════════════════
# 🎯 第七部分：出站策略组（代理分组）
# ════════════════════════════════════════════════════════════════════════════
# 说明：这里定义了不同的代理策略，规则会指向这些策略

proxy-groups:
  
  # ┌─────────────────────────────────────────────────────────┐
  # │ 主策略 - 你可以手动切换的主代理                          │
  # └─────────────────────────────────────────────────────────┘
  - {name: 🚀 默认代理, type: select, proxies: [🔯 香港故转, 🔯 日本故转, ♻️ 香港自动, ♻️ 日本自动, 🇭🇰 香港节点, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}

  # ┌─────────────────────────────────────────────────────────┐
  # │ AI 服务 - 每个 AI 分开管理（便于针对优化）              │
  # └─────────────────────────────────────────────────────────┘
  - {name: 🤖 ChatGPT, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🧠 Claude, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🔮 Gemini, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🎯 Copilot, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}

  # ┌─────────────────────────────────────────────────────────┐
  # │ 常用服务                                               │
  # └─────────────────────────────────────────────────────────┘
  - {name: 📹 YouTube, type: select, proxies: [🔯 日本故转, 🔯 香港故转, ♻️ 日本自动, ♻️ 香港自动, 🇯🇵 日本节点, 🇭🇰 香港节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🍀 Google, type: select, proxies: [🔯 香港故转, 🔯 日本故转, ♻️ 香港自动, ♻️ 日本自动, 🇭🇰 香港节点, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 👨‍💻 GitHub, type: select, proxies: [🔯 香港故转, 🔯 日本故转, ♻️ 香港自动, ♻️ 日本自动, 🇭🇰 香港节点, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🎵 TikTok, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🐳 Docker, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 📲 Telegram, type: select, proxies: [🔯 香港故转, 🔯 日本故转, ♻️ 香港自动, ♻️ 日本自动, 🇭🇰 香港节点, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}
  - {name: 🎥 Netflix, type: select, proxies: [🔯 日本故转, ♻️ 日本自动, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}

  # ┌─────────────────────────────────────────────────────────┐
  # │ 兜底策略 - 规则未匹配的流量走这里                       │
  # └─────────────────────────────────────────────────────────┘
  - {name: 🐟 漏网之鱼, type: select, proxies: [🔯 香港故转, 🔯 日本故转, ♻️ 香港自动, ♻️ 日本自动, 🇭🇰 香港节点, 🇯🇵 日本节点, 🇺🇸 美国节点, 🌍 其他地区, 直连]}

  # ┌─────────────────────────────────────────────────────────┐
  # │ 节点分组 - 按国家分类                                   │
  # │ type 说明：                                             │
  # │   select = 手动选择                                     │
  # │   fallback = 故转（自动从列表选一个可用的）             │
  # │   url-test = 自动（根据延迟自动选最快的）              │
  # └─────────────────────────────────────────────────────────┘
  
  # 香港节点分组
  - {name: 🇭🇰 香港节点, type: select, include-all: true, filter: "(?=.*(港|HK|Hong))^((?!(台|日|韩|新|美)).)*$"}
  - {name: 🔯 香港故转, type: fallback, include-all: true, interval: 300, filter: "(?=.*(港|HK|Hong))^((?!(台|日|韩|新|美)).)*$"}
  - {name: ♻️ 香港自动, type: url-test, include-all: true, tolerance: 20, interval: 300, filter: "(?=.*(港|HK|Hong))^((?!(台|日|韩|新|美)).)*$"}

  # 日本节点分组
  - {name: 🇯🇵 日本节点, type: select, include-all: true, filter: "(?=.*(日|JP|Japan))^((?!(港|台|韩|新|美)).)*$"}
  - {name: 🔯 日本故转, type: fallback, include-all: true, interval: 300, filter: "(?=.*(日|JP|Japan))^((?!(港|台|韩|新|美)).)*$"}
  - {name: ♻️ 日本自动, type: url-test, include-all: true, tolerance: 20, interval: 300, filter: "(?=.*(日|JP|Japan))^((?!(港|台|韩|新|美)).)*$"}

  # 美国节点分组
  - {name: 🇺🇸 美国节点, type: select, include-all: true, filter: "(?=.*(美|US|States|America))^((?!(港|台|日|韩|新)).)*$"}

  # 其他地区节点分组
  - {name: 🌍 其他地区, type: select, include-all: true, filter: "^((?!(直连|拒绝|港|HK|Hong|日|JP|Japan|美|US|States|America)).)*$"}

# ════════════════════════════════════════════════════════════════════════════
# 📋 第八部分：规则集锚点定义
# ════════════════════════════════════════════════════════════════════════════
# 说明：这里定义规则集的公共属性，避免重复写

rule-anchor:
  # IP 规则集
  ip: &ip {type: http, interval: 86400, behavior: ipcidr, format: mrs}
  # 域名规则集
  domain: &domain {type: http, interval: 86400, behavior: domain, format: mrs}
  # 经典规则集（文本格式）
  class: &class {type: http, interval: 86400, behavior: classical, format: text}

# ════════════════════════════════════════════════════════════════════════════
# 🔗 第九部分：规则集提供者（从 GitHub 下载规则）
# ════════════════════════════════════════════════════════════════════════════
# 说明：这些规则集定义了哪些流量应该如何处理
# 每个规则集都有一个名字，在下面的 rules 部分会被引用

rule-providers:
  
  # ┌─────────────────────────────────────────────────────────┐
  # │ 基础规则（必需）                                         │
  # └─────────────────────────────────────────────────────────┘
  fakeipfilter: {<<: *domain, url: "https://raw.githubusercontent.com/wwqgtxx/clash-rules/release/fakeip-filter.mrs"}
  private_domain: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/private.mrs"}
  private_ip: {<<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/private.mrs"}
  cn_domain: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/cn.mrs"}
  cn_ip: {<<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/cn.mrs"}

  # ┌─────────────────────────────────────────────────────────┐
  # │ AI 服务规则（每个单独分类）                              │
  # └─────────────────────────────────────────────────────────┘
  chatgpt: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/openai.mrs"}
  claude: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/anthropic.mrs"}
  gemini: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.mrs"}
  copilot: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/microsoft.mrs"}

  # ┌─────────────────────────────────────────────────────────┐
  # │ 常用服务规则                                             │
  # └─────────────────────────────────────────────────────────┘
  youtube: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/youtube.mrs"}
  google: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/google.mrs"}
  github: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/github.mrs"}
  tiktok: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/tiktok.mrs"}
  docker: {<<: *class, url: "https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Docker/Docker.list"}
  telegram: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/telegram.mrs"}
  telegram_ip: {<<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/telegram.mrs"}
  netflix: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/netflix.mrs"}
  netflix_ip: {<<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/netflix.mrs"}
  apple: {<<: *domain, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/apple.mrs"}
  apple_ip: {<<: *ip, url: "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geoip/apple.mrs"}

# ════════════════════════════════════════════════════════════════════════════
# 📝 第十部分：规则匹配（最关键的部分！）
# ════════════════════════════════════════════════════════════════════════════
# 说明：
# 规则从上往下依次匹配，匹配到就立即应用，不会继续往下
# 格式：RULE-SET,规则名,策略名
# 最后的 MATCH 是兜底规则，所有未匹配的流量都走这里

rules:
  
  # ┌─────────────────────────────────────────────────────────┐
  # │ 私有网络和域名 → 直连（不走代理）                       │
  # │ 说明：局域网、内网资源不需要代理                         │
  # └─────────────────────────────────────────────────────────┘
  - RULE-SET,private_ip,直连,no-resolve
  - RULE-SET,private_domain,直连

  # ┌─────────────────────────────────────────────────────────┐
  # │ AI 服务 → 各自的策略                                    │
  # │ 说明：ChatGPT/Claude 等各自走最优路线                   │
  # └─────────────────────────────────────────────────────────┘
  - RULE-SET,chatgpt,🤖 ChatGPT
  - RULE-SET,claude,🧠 Claude
  - RULE-SET,gemini,🔮 Gemini
  - RULE-SET,copilot,🎯 Copilot

  # ┌─────────────────────────────────────────────────────────┐
  # │ 常用服务 → 各自的策略                                   │
  # └─────────────────────────────────────────────────────────┘
  - RULE-SET,youtube,📹 YouTube
  - RULE-SET,google,🍀 Google
  - RULE-SET,github,👨‍💻 GitHub
  - RULE-SET,tiktok,🎵 TikTok
  - RULE-SET,docker,🐳 Docker
  - RULE-SET,telegram,📲 Telegram
  - RULE-SET,telegram_ip,📲 Telegram,no-resolve
  - RULE-SET,netflix,🎥 Netflix
  - RULE-SET,netflix_ip,🎥 Netflix,no-resolve

  # ┌─────────────────────────────────────────────────────────┐
  # │ 苹果服务 → 直连（国内 Apple 服务用直连更稳定）         │
  # └─────────────────────────────────────────────────────────┘
  - RULE-SET,apple,直连
  - RULE-SET,apple_ip,直连,no-resolve

  # ┌─────────────────────────────────────────────────────────┐
  # │ 国内域名和 IP → 直连（国内资源用直连）                 │
  # │ 说明：这里会自动覆盖所有国内网站，不需要走代理         │
  # └─────────────────────────────────────────────────────────┘
  - RULE-SET,cn_domain,直连
  - RULE-SET,cn_ip,直连,no-resolve

  # ┌─────────────────────────────────────────────────────────┐
  # │ 默认规则 → 兜底策略                                     │
  # │ 说明：所有未匹配的流量都走漏网之鱼                       │
  # │ MATCH 是通配符，表示"所有其他情况"                     │
  # └─────────────────────────────────────────────────────────┘
  - MATCH,🐟 漏网之鱼

# ════════════════════════════════════════════════════════════════════════════
# 📌 配置完成！使用说明
# ════════════════════════════════════════════════════════════════════════════
#
# ✅ 必须要改的地方：
#   1. 第 6 行：把 "https://your-airport-subscribe-link.com" 改成你的机场链接
#
# ✅ 检查 ADH 配置（重要！）：
#   - ADH 上游 DNS：改成 192.168.10.2:7874
#   - 这样 ADH 会把 DNS 查询转发到 OpenClash
#
# ✅ 检查 OP 配置（iKuai 虚拟机）：
#   - 自定义 DNS：192.168.10.6（指向 ADH）
#   - DNS 转发：223.5.5.5（备用 DNS）
#   - DNS 重定向：留空
#
# ✅ 工作流程：
#   设备 → iKuai DHCP (DNS: 192.168.10.6)
#       → ADH (192.168.10.6)
#           → ADH 上游 (192.168.10.2:7874)
#               → OpenClash DNS
#                   → 根据规则匹配相应策略
#
# ✅ 如何添加新规则：
#   1. 在 rule-providers 中添加新规则集
#   2. 在 proxy-groups 中添加新策略（可选）
#   3. 在 rules 中添加匹配规则
#   示例：
#     facebook: {<<: *domain, url: "..."}  # 添加规则集
#     - {name: Facebook, type: select, proxies: [...]}  # 添加策略
#     - RULE-SET,facebook,Facebook  # 添加匹配规则
#
# ════════════════════════════════════════════════════════════════════════════
